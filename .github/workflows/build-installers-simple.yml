name: Build SUSA Installers (Simplified)

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

env:
  SUSA_VERSION: "1.0.0"

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc
      
      - name: Build SUSA Compiler
        shell: msys2 {0}
        run: |
          cd cpp-core
          echo "Building SUSA with g++..."
          g++ -std=c++17 -Wall -O2 -static -o susa.exe main.cpp
          ls -lh susa.exe
      
      - name: Create LICENSE.txt
        run: |
          echo "MIT License" > LICENSE.txt
          echo "" >> LICENSE.txt
          echo "Copyright (c) 2026 SUSA Team" >> LICENSE.txt
      
      - name: Create README.txt
        run: |
          echo "SUSA Programming Language v${{ env.SUSA_VERSION }}" > README.txt
          echo "Visit https://susastudio.online for documentation" >> README.txt
      
      - name: Create NSIS Installer Script
        run: |
          $nsiContent = @'
          !define PRODUCT_NAME "SUSA Programming Language"
          !define PRODUCT_VERSION "${{ env.SUSA_VERSION }}"
          !include "MUI2.nsh"
          !define MUI_ABORTWARNING
          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_LICENSE "LICENSE.txt"
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH
          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES
          !insertmacro MUI_LANGUAGE "English"
          Name "${PRODUCT_NAME}"
          OutFile "SUSA-Setup-${{ env.SUSA_VERSION }}.exe"
          InstallDir "$PROGRAMFILES64\SUSA"
          ShowInstDetails show
          RequestExecutionLevel admin
          Section "SUSA"
            SetOutPath "$INSTDIR"
            File "cpp-core\susa.exe"
            File "LICENSE.txt"
            File "README.txt"
            WriteUninstaller "$INSTDIR\uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\SUSA" "DisplayName" "SUSA"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\SUSA" "UninstallString" "$INSTDIR\uninstall.exe"
            EnVar::SetHKLM
            EnVar::AddValue "PATH" "$INSTDIR"
            CreateShortCut "$DESKTOP\SUSA.lnk" "$INSTDIR\susa.exe"
          SectionEnd
          Section Uninstall
            Delete "$INSTDIR\susa.exe"
            Delete "$INSTDIR\LICENSE.txt"
            Delete "$INSTDIR\README.txt"
            Delete "$INSTDIR\uninstall.exe"
            RMDir "$INSTDIR"
            Delete "$DESKTOP\SUSA.lnk"
            EnVar::SetHKLM
            EnVar::DeleteValue "PATH" "$INSTDIR"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\SUSA"
          SectionEnd
          '@
          $nsiContent | Out-File -FilePath "installer.nsi" -Encoding ASCII
      
      - name: Build NSIS Installer
        uses: joncloud/makensis-action@v4
        with:
          script-file: installer.nsi
      
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: SUSA-Setup-${{ env.SUSA_VERSION }}.exe

  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          clang++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Create package structure
        run: |
          mkdir -p package/usr/local/bin
          cp cpp-core/susa package/usr/local/bin/
          chmod +x package/usr/local/bin/susa
      
      - name: Create scripts
        run: |
          mkdir -p scripts
          cat > scripts/postinstall << 'EOF'
          #!/bin/bash
          echo 'export PATH="$PATH:/usr/local/bin"' >> "$HOME/.zshrc"
          echo 'export PATH="$PATH:/usr/local/bin"' >> "$HOME/.bash_profile"
          echo "SUSA installed! Run 'susa --version'"
          EOF
          chmod +x scripts/postinstall
      
      - name: Build PKG
        run: |
          pkgbuild --root package --identifier com.susa.pkg --version ${{ env.SUSA_VERSION }} --scripts scripts --install-location / susa.pkg
          productbuild --package susa.pkg SUSA-${{ env.SUSA_VERSION }}.pkg
      
      - name: Upload macOS Installer
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: SUSA-${{ env.SUSA_VERSION }}.pkg

  build-linux-appimage:
    name: Build Linux AppImage (Universal)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y g++ wget fuse libfuse2
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          g++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Download AppImage tools
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
      
      - name: Create AppImage structure
        run: |
          mkdir -p SUSA.AppDir/usr/bin
          cp cpp-core/susa SUSA.AppDir/usr/bin/
          cat > SUSA.AppDir/AppRun << 'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")"
          exec "$APPDIR/usr/bin/susa" "$@"
          EOF
          chmod +x SUSA.AppDir/AppRun
          cat > SUSA.AppDir/susa.desktop << 'EOF'
          [Desktop Entry]
          Name=SUSA
          Exec=susa
          Type=Application
          Categories=Development;
          EOF
      
      - name: Build AppImage
        run: |
          ./appimagetool-x86_64.AppImage SUSA.AppDir SUSA-${{ env.SUSA_VERSION }}-x86_64.AppImage
          chmod +x SUSA-${{ env.SUSA_VERSION }}-x86_64.AppImage
      
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: SUSA-${{ env.SUSA_VERSION }}-x86_64.AppImage

  build-linux-deb:
    name: Build Linux DEB
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          g++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
      
      - name: Create DEB package
        run: |
          mkdir -p susa-deb/DEBIAN susa-deb/usr/local/bin
          cp cpp-core/susa susa-deb/usr/local/bin/
          cat > susa-deb/DEBIAN/control << EOF
          Package: susa
          Version: ${{ env.SUSA_VERSION }}
          Architecture: amd64
          Maintainer: SUSA Team
          Description: SUSA Programming Language
          EOF
          cat > susa-deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          echo 'export PATH="$PATH:/usr/local/bin"' > /etc/profile.d/susa.sh
          EOF
          chmod +x susa-deb/DEBIAN/postinst
          dpkg-deb --build susa-deb
          mv susa-deb.deb susa_${{ env.SUSA_VERSION }}_amd64.deb
      
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: susa_${{ env.SUSA_VERSION }}_amd64.deb

  build-linux-rpm:
    name: Build Linux RPM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y g++ rpm
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          g++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
      
      - name: Create RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p susa-${{ env.SUSA_VERSION }}
          cp cpp-core/susa susa-${{ env.SUSA_VERSION }}/
          tar czf ~/rpmbuild/SOURCES/susa-${{ env.SUSA_VERSION }}.tar.gz susa-${{ env.SUSA_VERSION }}
          cat > ~/rpmbuild/SPECS/susa.spec << 'EOF'
          Name: susa
          Version: ${{ env.SUSA_VERSION }}
          Release: 1
          Summary: SUSA Programming Language
          License: MIT
          Source0: susa-${{ env.SUSA_VERSION }}.tar.gz
          %description
          SUSA Programming Language
          %prep
          %setup -q
          %install
          mkdir -p %{buildroot}/usr/local/bin
          install -m 0755 susa %{buildroot}/usr/local/bin/susa
          %files
          /usr/local/bin/susa
          EOF
          rpmbuild -ba ~/rpmbuild/SPECS/susa.spec
          cp ~/rpmbuild/RPMS/x86_64/susa-${{ env.SUSA_VERSION }}-1.*.rpm ./susa-${{ env.SUSA_VERSION }}-1.x86_64.rpm
      
      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: susa-${{ env.SUSA_VERSION }}-1.x86_64.rpm

  create-release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux-appimage, build-linux-deb, build-linux-rpm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-installer/*.exe
            macos-installer/*.pkg
            linux-appimage/*.AppImage
            linux-deb/*.deb
            linux-rpm/*.rpm
          body: |
            ## SUSA Programming Language v${{ env.SUSA_VERSION }}
            
            ### Downloads
            - **Windows**: SUSA-Setup-${{ env.SUSA_VERSION }}.exe
            - **macOS**: SUSA-${{ env.SUSA_VERSION }}.pkg
            - **Linux (Universal)**: SUSA-${{ env.SUSA_VERSION }}-x86_64.AppImage â­
            - **Linux (DEB)**: susa_${{ env.SUSA_VERSION }}_amd64.deb
            - **Linux (RPM)**: susa-${{ env.SUSA_VERSION }}-1.x86_64.rpm
            
            Visit [susastudio.online](https://susastudio.online) for documentation.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
