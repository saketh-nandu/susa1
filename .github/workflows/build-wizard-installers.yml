name: Build Wizard Installers (DEB, RPM, PKG) - All Variants

on:
  workflow_dispatch:

jobs:
  build-all-linux-macos:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential rpm
      
      - name: Build CLI
        run: |
          cd cpp-core
          g++ -std=c++17 -O2 main.cpp -o susa
          chmod +x susa
          cp susa ../susa-cpp
      
      - name: Build IDE
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install --legacy-peer-deps
          npm run dist:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create DEB Packages
        run: |
          # 1. CLI DEB
          mkdir -p susa-cli-deb/DEBIAN
          mkdir -p susa-cli-deb/usr/local/bin
          mkdir -p susa-cli-deb/usr/local/share/susa/{modules,examples}
          cp cpp-core/susa susa-cli-deb/usr/local/bin/
          if [ -d "modules" ]; then cp -r modules/* susa-cli-deb/usr/local/share/susa/modules/ 2>/dev/null || true; fi
          if [ -d "examples" ]; then cp -r examples/* susa-cli-deb/usr/local/share/susa/examples/ 2>/dev/null || true; fi
          cat > susa-cli-deb/DEBIAN/control << EOF
          Package: susa-cli
          Version: 1.0.0
          Architecture: amd64
          Maintainer: SUSA Team <contact@susastudio.online>
          Description: SUSA CLI - Command Line Interface
          Homepage: https://susastudio.online
          EOF
          dpkg-deb --build susa-cli-deb susa-cli_1.0.0_amd64.deb
          
          # 2. IDE DEB
          mkdir -p susa-ide-deb/DEBIAN
          mkdir -p susa-ide-deb/opt/susa-ide
          mkdir -p susa-ide-deb/usr/share/applications
          cp susa-ide/remix-of-susa-studio-ide-main/dist-electron/*.AppImage susa-ide-deb/opt/susa-ide/susa-ide || true
          cat > susa-ide-deb/DEBIAN/control << EOF
          Package: susa-ide
          Version: 1.0.0
          Architecture: amd64
          Maintainer: SUSA Team <contact@susastudio.online>
          Description: SUSA IDE - Desktop Development Environment
          Homepage: https://susastudio.online
          EOF
          cat > susa-ide-deb/usr/share/applications/susa-ide.desktop << EOF
          [Desktop Entry]
          Name=SUSA IDE
          Exec=/opt/susa-ide/susa-ide
          Icon=susa
          Type=Application
          Categories=Development;IDE;
          EOF
          dpkg-deb --build susa-ide-deb susa-ide_1.0.0_amd64.deb
          
          # 3. Complete DEB
          mkdir -p susa-complete-deb/DEBIAN
          mkdir -p susa-complete-deb/usr/local/bin
          mkdir -p susa-complete-deb/usr/local/share/susa/{modules,examples}
          mkdir -p susa-complete-deb/opt/susa-ide
          mkdir -p susa-complete-deb/usr/share/applications
          cp cpp-core/susa susa-complete-deb/usr/local/bin/
          if [ -d "modules" ]; then cp -r modules/* susa-complete-deb/usr/local/share/susa/modules/ 2>/dev/null || true; fi
          if [ -d "examples" ]; then cp -r examples/* susa-complete-deb/usr/local/share/susa/examples/ 2>/dev/null || true; fi
          cp susa-ide/remix-of-susa-studio-ide-main/dist-electron/*.AppImage susa-complete-deb/opt/susa-ide/susa-ide || true
          cat > susa-complete-deb/DEBIAN/control << EOF
          Package: susa-complete
          Version: 1.0.0
          Architecture: amd64
          Maintainer: SUSA Team <contact@susastudio.online>
          Description: SUSA Complete - CLI + IDE
          Homepage: https://susastudio.online
          EOF
          cat > susa-complete-deb/usr/share/applications/susa-ide.desktop << EOF
          [Desktop Entry]
          Name=SUSA IDE
          Exec=/opt/susa-ide/susa-ide
          Icon=susa
          Type=Application
          Categories=Development;IDE;
          EOF
          dpkg-deb --build susa-complete-deb susa-complete_1.0.0_amd64.deb
      
      - name: Upload DEB Packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb-all
          path: |
            susa-cli_1.0.0_amd64.deb
            susa-ide_1.0.0_amd64.deb
            susa-complete_1.0.0_amd64.deb

  build-macos-pkg-all:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build CLI
        run: |
          cd cpp-core
          clang++ -std=c++17 -O2 -arch x86_64 -arch arm64 main.cpp -o susa 2>/dev/null || \
          clang++ -std=c++17 -O2 -arch x86_64 main.cpp -o susa
          chmod +x susa
          cp susa ../susa-cpp
      
      - name: Build IDE
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install --legacy-peer-deps
          npm run dist:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create PKG Installers
        run: |
          # Copy logo for installers (handle space in filename)
          cp 'susa logo.png' susa-logo.png 2>/dev/null || echo "Logo not found, continuing..."
          
          # Create professional welcome page with logo
          cat > welcome.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8"/>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; padding: 20px; }
              .logo { text-align: center; margin: 20px 0; }
              .logo img { width: 128px; height: 128px; }
              h1 { color: #2563eb; text-align: center; }
              .features { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0; }
              .features ul { margin: 10px 0; }
              .features li { margin: 5px 0; }
            </style>
          </head>
          <body>
            <div class="logo">
              <img src="susa-logo.png" alt="SUSA Logo"/>
            </div>
            <h1>Welcome to SUSA v1.0.0</h1>
            <p><strong>Modern Programming Language with English-Like Syntax</strong></p>
            
            <div class="features">
              <h3>âœ¨ What's Included:</h3>
              <ul>
                <li>âœ… 40 Complete Language Features</li>
                <li>âœ… Object-Oriented Programming</li>
                <li>âœ… Functional Programming</li>
                <li>âœ… Async/Await Support</li>
                <li>âœ… Generators and Yield</li>
                <li>âœ… 9 Built-in Modules (290+ Functions)</li>
                <li>âœ… Fast C++ Interpreter</li>
              </ul>
            </div>
            
            <p><strong>Perfect for:</strong> Beginners learning programming, professionals building applications, educators teaching coding.</p>
            
            <p style="text-align: center; margin-top: 30px;">
              <strong>Website:</strong> <a href="https://susastudio.online">susastudio.online</a>
            </p>
          </body>
          </html>
          EOF
          
          # Create professional conclusion page
          cat > conclusion.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8"/>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; padding: 20px; }
              .logo { text-align: center; margin: 20px 0; }
              .logo img { width: 96px; height: 96px; }
              h1 { color: #16a34a; text-align: center; }
              .success { background: #dcfce7; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #16a34a; }
              .commands { background: #1f2937; color: #f9fafb; padding: 15px; border-radius: 8px; font-family: monospace; }
              .next-steps { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0; }
            </style>
          </head>
          <body>
            <div class="logo">
              <img src="susa-logo.png" alt="SUSA Logo"/>
            </div>
            <h1>ðŸŽ‰ Installation Complete!</h1>
            
            <div class="success">
              <p><strong>SUSA has been successfully installed on your Mac!</strong></p>
            </div>
            
            <div class="next-steps">
              <h3>ðŸš€ Get Started:</h3>
              <p><strong>Run SUSA from Terminal:</strong></p>
              <div class="commands">
                <p>$ susa --version</p>
                <p>$ susa myprogram.susa</p>
              </div>
            </div>
            
            <div class="next-steps">
              <h3>ðŸ“š Learn More:</h3>
              <ul>
                <li>Documentation: <a href="https://susastudio.online/docs">susastudio.online/docs</a></li>
                <li>Examples: Check /usr/local/share/susa/examples/</li>
                <li>Community: <a href="https://susastudio.online/community">susastudio.online/community</a></li>
              </ul>
            </div>
            
            <p style="text-align: center; margin-top: 30px; color: #6b7280;">
              Thank you for choosing SUSA! Happy coding! ðŸ’»
            </p>
          </body>
          </html>
          EOF
          
          # Create license file
          cat > license.txt << 'EOF'
          MIT License
          
          Copyright (c) 2026 SUSA Development Team
          
          Permission is hereby granted, free of charge, to any person obtaining a copy
          of this software and associated documentation files (the "Software"), to deal
          in the Software without restriction, including without limitation the rights
          to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
          copies of the Software, and to permit persons to whom the Software is
          furnished to do so, subject to the following conditions:
          
          The above copyright notice and this permission notice shall be included in all
          copies or substantial portions of the Software.
          
          THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
          IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
          FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
          AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
          LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
          OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
          SOFTWARE.
          EOF
          
          # 1. CLI PKG
          mkdir -p susa-cli-pkg/usr/local/bin
          mkdir -p susa-cli-pkg/usr/local/share/susa/{modules,examples}
          cp cpp-core/susa susa-cli-pkg/usr/local/bin/
          if [ -d "modules" ]; then cp -r modules/* susa-cli-pkg/usr/local/share/susa/modules/ 2>/dev/null || true; fi
          if [ -d "examples" ]; then cp -r examples/* susa-cli-pkg/usr/local/share/susa/examples/ 2>/dev/null || true; fi
          pkgbuild --root susa-cli-pkg --identifier com.susa.cli --version 1.0.0 --install-location / SUSA-CLI-1.0.0-component.pkg
          
          cat > distribution-cli.xml << 'EOF'
          <?xml version="1.0"?>
          <installer-gui-script minSpecVersion="1">
              <title>SUSA CLI v1.0.0</title>
              <organization>com.susa</organization>
              <welcome file="welcome.html"/>
              <license file="license.txt"/>
              <conclusion file="conclusion.html"/>
              <background file="susa-logo.png" alignment="bottomleft" scaling="none"/>
              <pkg-ref id="com.susa.cli"/>
              <choices-outline><line choice="com.susa.cli"/></choices-outline>
              <choice id="com.susa.cli" title="SUSA CLI"><pkg-ref id="com.susa.cli"/></choice>
              <pkg-ref id="com.susa.cli">SUSA-CLI-1.0.0-component.pkg</pkg-ref>
          </installer-gui-script>
          EOF
          
          productbuild --distribution distribution-cli.xml --resources . SUSA-CLI-1.0.0.pkg
          
          # 2. IDE PKG
          mkdir -p susa-ide-pkg/Applications
          if [ -d susa-ide/remix-of-susa-studio-ide-main/dist-electron/mac*/*.app ]; then
            cp -r susa-ide/remix-of-susa-studio-ide-main/dist-electron/mac*/*.app susa-ide-pkg/Applications/ 2>/dev/null || true
          fi
          pkgbuild --root susa-ide-pkg --identifier com.susa.ide --version 1.0.0 --install-location / SUSA-IDE-1.0.0-component.pkg
          
          cat > distribution-ide.xml << 'EOF'
          <?xml version="1.0"?>
          <installer-gui-script minSpecVersion="1">
              <title>SUSA IDE v1.0.0</title>
              <organization>com.susa</organization>
              <welcome file="welcome.html"/>
              <license file="license.txt"/>
              <conclusion file="conclusion.html"/>
              <background file="susa-logo.png" alignment="bottomleft" scaling="none"/>
              <pkg-ref id="com.susa.ide"/>
              <choices-outline><line choice="com.susa.ide"/></choices-outline>
              <choice id="com.susa.ide" title="SUSA IDE"><pkg-ref id="com.susa.ide"/></choice>
              <pkg-ref id="com.susa.ide">SUSA-IDE-1.0.0-component.pkg</pkg-ref>
          </installer-gui-script>
          EOF
          
          productbuild --distribution distribution-ide.xml --resources . SUSA-IDE-1.0.0.pkg
          
          # Also keep DMG for IDE
          if [ -f susa-ide/remix-of-susa-studio-ide-main/dist-electron/*.dmg ]; then
            cp susa-ide/remix-of-susa-studio-ide-main/dist-electron/*.dmg SUSA-IDE-1.0.0.dmg
          fi
          
          # 3. Complete PKG (CLI + IDE)
          mkdir -p susa-complete-pkg/usr/local/bin
          mkdir -p susa-complete-pkg/usr/local/share/susa/{modules,examples}
          mkdir -p susa-complete-pkg/Applications
          cp cpp-core/susa susa-complete-pkg/usr/local/bin/
          if [ -d "modules" ]; then cp -r modules/* susa-complete-pkg/usr/local/share/susa/modules/ 2>/dev/null || true; fi
          if [ -d "examples" ]; then cp -r examples/* susa-complete-pkg/usr/local/share/susa/examples/ 2>/dev/null || true; fi
          # Copy IDE app if it exists
          if [ -d susa-ide/remix-of-susa-studio-ide-main/dist-electron/mac*/*.app ]; then
            cp -r susa-ide/remix-of-susa-studio-ide-main/dist-electron/mac*/*.app susa-complete-pkg/Applications/ 2>/dev/null || true
          fi
          pkgbuild --root susa-complete-pkg --identifier com.susa.complete --version 1.0.0 --install-location / SUSA-Complete-1.0.0-component.pkg
          
          cat > distribution-complete.xml << 'EOF'
          <?xml version="1.0"?>
          <installer-gui-script minSpecVersion="1">
              <title>SUSA Complete v1.0.0</title>
              <organization>com.susa</organization>
              <welcome file="welcome.html"/>
              <license file="license.txt"/>
              <conclusion file="conclusion.html"/>
              <background file="susa-logo.png" alignment="bottomleft" scaling="none"/>
              <pkg-ref id="com.susa.complete"/>
              <choices-outline><line choice="com.susa.complete"/></choices-outline>
              <choice id="com.susa.complete" title="SUSA Complete (CLI + IDE)"><pkg-ref id="com.susa.complete"/></choice>
              <pkg-ref id="com.susa.complete">SUSA-Complete-1.0.0-component.pkg</pkg-ref>
          </installer-gui-script>
          EOF
          
          productbuild --distribution distribution-complete.xml --resources . SUSA-Complete-1.0.0.pkg
      
      - name: Upload PKG Installers
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg-all
          path: |
            SUSA-CLI-1.0.0.pkg
            SUSA-IDE-1.0.0.pkg
            SUSA-IDE-1.0.0.dmg
            SUSA-Complete-1.0.0.pkg
