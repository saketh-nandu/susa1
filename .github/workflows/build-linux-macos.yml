name: Build SUSA for Linux and macOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Build Tools
        run: sudo apt-get update && sudo apt-get install -y build-essential
      
      - name: Build Linux Binary
        run: |
          cd cpp-core
          g++ -std=c++17 -O2 main.cpp -o susa
          chmod +x susa
          ls -lh susa
      
      - name: Test Binary
        run: |
          cd cpp-core
          ./susa --version || echo "Binary built successfully"
      
      - name: Create Linux Package Directory
        run: |
          mkdir -p susa-linux-package/usr/local/bin
          mkdir -p susa-linux-package/usr/local/share/susa/modules
          mkdir -p susa-linux-package/usr/local/share/susa/examples
          cp cpp-core/susa susa-linux-package/usr/local/bin/
          cp -r modules/* susa-linux-package/usr/local/share/susa/modules/
          cp -r examples/* susa-linux-package/usr/local/share/susa/examples/
      
      - name: Create Tarball
        run: |
          tar -czf SUSA-Linux-1.0.0.tar.gz susa-linux-package
          ls -lh SUSA-Linux-1.0.0.tar.gz
      
      - name: Upload Linux Binary
        uses: actions/upload-artifact@v4
        with:
          name: susa-linux-binary
          path: cpp-core/susa
      
      - name: Upload Linux Package
        uses: actions/upload-artifact@v4
        with:
          name: susa-linux-package
          path: SUSA-Linux-1.0.0.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build macOS Binary (Universal)
        run: |
          cd cpp-core
          # Try universal binary first
          clang++ -std=c++17 -O2 -arch x86_64 -arch arm64 main.cpp -o susa 2>/dev/null || \
          # Fallback to x86_64 only if universal fails
          clang++ -std=c++17 -O2 -arch x86_64 main.cpp -o susa
          chmod +x susa
          ls -lh susa
          file susa
      
      - name: Test Binary
        run: |
          cd cpp-core
          ./susa --version || echo "Binary built successfully"
      
      - name: Create macOS Package Directory
        run: |
          mkdir -p susa-macos-package/usr/local/bin
          mkdir -p susa-macos-package/usr/local/share/susa/modules
          mkdir -p susa-macos-package/usr/local/share/susa/examples
          cp cpp-core/susa susa-macos-package/usr/local/bin/
          cp -r modules/* susa-macos-package/usr/local/share/susa/modules/
          cp -r examples/* susa-macos-package/usr/local/share/susa/examples/
      
      - name: Create Tarball
        run: |
          tar -czf SUSA-macOS-1.0.0.tar.gz susa-macos-package
          ls -lh SUSA-macOS-1.0.0.tar.gz
      
      - name: Upload macOS Binary
        uses: actions/upload-artifact@v4
        with:
          name: susa-macos-binary
          path: cpp-core/susa
      
      - name: Upload macOS Package
        uses: actions/upload-artifact@v4
        with:
          name: susa-macos-package
          path: SUSA-macOS-1.0.0.tar.gz

  create-release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: Display Downloaded Files
        run: |
          echo "Downloaded artifacts:"
          ls -R
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            susa-linux-binary/susa
            susa-linux-package/SUSA-Linux-1.0.0.tar.gz
            susa-macos-binary/susa
            susa-macos-package/SUSA-macOS-1.0.0.tar.gz
          body: |
            # SUSA v1.0.0 - First Stable Release
            
            Modern programming language with English-like syntax.
            
            ## ðŸŽ‰ Features
            - 40 complete language features
            - Object-oriented programming
            - Functional programming
            - Async/await support
            - Generators and yield
            - 9 built-in modules (290+ functions)
            - Fast C++ interpreter
            
            ## ðŸ“¦ Downloads
            
            ### Linux
            - `susa` - Linux executable (x86_64)
            - `SUSA-Linux-1.0.0.tar.gz` - Complete package with modules and examples
            
            **Installation:**
            ```bash
            # Extract and install
            tar -xzf SUSA-Linux-1.0.0.tar.gz
            cd susa-linux-package
            sudo cp usr/local/bin/susa /usr/local/bin/
            sudo cp -r usr/local/share/susa /usr/local/share/
            
            # Test
            susa --version
            ```
            
            ### macOS
            - `susa` - macOS executable (Universal: Intel + Apple Silicon)
            - `SUSA-macOS-1.0.0.tar.gz` - Complete package with modules and examples
            
            **Installation:**
            ```bash
            # Extract and install
            tar -xzf SUSA-macOS-1.0.0.tar.gz
            cd susa-macos-package
            sudo cp usr/local/bin/susa /usr/local/bin/
            sudo cp -r usr/local/share/susa /usr/local/share/
            
            # Test
            susa --version
            ```
            
            ### Windows
            Windows installers will be uploaded separately.
            
            ## ðŸ“š Documentation
            - [Getting Started](https://susastudio.online/docs)
            - [Language Reference](https://github.com/saketh-nandu/susa1/blob/main/README.md)
            - [Examples](https://github.com/saketh-nandu/susa1/tree/main/examples)
            
            ## ðŸ”— Links
            - Website: https://susastudio.online
            - Repository: https://github.com/saketh-nandu/susa1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
