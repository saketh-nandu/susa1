name: Build SUSA IDE for All Platforms

on:
  workflow_dispatch:

jobs:
  build-linux-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Linux CLI
        run: |
          cd cpp-core
          g++ -std=c++17 -O2 main.cpp -o susa
          chmod +x susa
      
      - name: Create CLI Package
        run: |
          mkdir -p SUSA-CLI-Linux/bin
          mkdir -p SUSA-CLI-Linux/modules
          mkdir -p SUSA-CLI-Linux/examples
          cp cpp-core/susa SUSA-CLI-Linux/bin/
          cp -r modules/* SUSA-CLI-Linux/modules/
          cp -r examples/* SUSA-CLI-Linux/examples/
          tar -czf SUSA-CLI-Linux-1.0.0.tar.gz SUSA-CLI-Linux
      
      - name: Upload Linux CLI
        uses: actions/upload-artifact@v4
        with:
          name: linux-cli
          path: SUSA-CLI-Linux-1.0.0.tar.gz

  build-macos-cli:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build macOS CLI
        run: |
          cd cpp-core
          clang++ -std=c++17 -O2 -arch x86_64 -arch arm64 main.cpp -o susa 2>/dev/null || \
          clang++ -std=c++17 -O2 -arch x86_64 main.cpp -o susa
          chmod +x susa
      
      - name: Create CLI Package
        run: |
          mkdir -p SUSA-CLI-macOS/bin
          mkdir -p SUSA-CLI-macOS/modules
          mkdir -p SUSA-CLI-macOS/examples
          cp cpp-core/susa SUSA-CLI-macOS/bin/
          cp -r modules/* SUSA-CLI-macOS/modules/
          cp -r examples/* SUSA-CLI-macOS/examples/
          tar -czf SUSA-CLI-macOS-1.0.0.tar.gz SUSA-CLI-macOS
      
      - name: Upload macOS CLI
        uses: actions/upload-artifact@v4
        with:
          name: macos-cli
          path: SUSA-CLI-macOS-1.0.0.tar.gz

  build-linux-ide:
    runs-on: ubuntu-latest
    needs: build-linux-cli
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build Linux CLI
        run: |
          cd cpp-core
          g++ -std=c++17 -O2 main.cpp -o susa
          chmod +x susa
          cd ..
          cp cpp-core/susa susa-cpp
          cp cpp-core/susa susa-ide/remix-of-susa-studio-ide-main/susa-cpp
      
      - name: Install IDE Dependencies
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install --legacy-peer-deps
      
      - name: Build IDE for Linux
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm run dist:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: List built files
        run: |
          ls -lh susa-ide/remix-of-susa-studio-ide-main/dist-electron/
      
      - name: Upload Linux IDE
        uses: actions/upload-artifact@v4
        with:
          name: linux-ide
          path: susa-ide/remix-of-susa-studio-ide-main/dist-electron/*.AppImage

  build-macos-ide:
    runs-on: macos-latest
    needs: build-macos-cli
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build macOS CLI
        run: |
          cd cpp-core
          clang++ -std=c++17 -O2 -arch x86_64 -arch arm64 main.cpp -o susa 2>/dev/null || \
          clang++ -std=c++17 -O2 -arch x86_64 main.cpp -o susa
          chmod +x susa
          cd ..
          cp cpp-core/susa susa-cpp
          cp cpp-core/susa susa-ide/remix-of-susa-studio-ide-main/susa-cpp
      
      - name: Install IDE Dependencies
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install --legacy-peer-deps
      
      - name: Build IDE for macOS
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm run dist:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: List built files
        run: |
          ls -lh susa-ide/remix-of-susa-studio-ide-main/dist-electron/
      
      - name: Upload macOS IDE
        uses: actions/upload-artifact@v4
        with:
          name: macos-ide
          path: |
            susa-ide/remix-of-susa-studio-ide-main/dist-electron/*.dmg
            susa-ide/remix-of-susa-studio-ide-main/dist-electron/*.zip

  create-complete-packages:
    runs-on: ubuntu-latest
    needs: [build-linux-cli, build-linux-ide, build-macos-cli, build-macos-ide]
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: List Downloaded Files
        run: |
          echo "Downloaded artifacts:"
          ls -R
      
      - name: Create Linux Complete Package
        run: |
          mkdir -p SUSA-Complete-Linux
          
          # Extract CLI package
          tar -xzf linux-cli/SUSA-CLI-Linux-1.0.0.tar.gz
          cp -r SUSA-CLI-Linux/* SUSA-Complete-Linux/
          
          # Copy IDE
          mkdir -p SUSA-Complete-Linux/ide
          cp linux-ide/*.AppImage SUSA-Complete-Linux/ide/ || echo "No AppImage found"
          
          # Create installation script
          cat > SUSA-Complete-Linux/install.sh << 'EOF'
          #!/bin/bash
          echo "Installing SUSA Complete Package for Linux..."
          echo ""
          
          # Install CLI
          echo "Installing CLI..."
          sudo cp bin/susa /usr/local/bin/
          sudo chmod +x /usr/local/bin/susa
          sudo cp -r modules /usr/local/share/susa/
          sudo cp -r examples /usr/local/share/susa/
          echo "✓ CLI installed"
          
          # Install IDE
          if [ -f ide/*.AppImage ]; then
            echo ""
            echo "Installing IDE..."
            sudo cp ide/*.AppImage /usr/local/bin/susa-ide
            sudo chmod +x /usr/local/bin/susa-ide
            
            # Create desktop entry
            cat > ~/.local/share/applications/susa-ide.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=SUSA IDE
          Comment=SUSA Programming Language IDE
          Exec=/usr/local/bin/susa-ide
          Icon=susa
          Terminal=false
          Type=Application
          Categories=Development;IDE;
          DESKTOP
            echo "✓ IDE installed"
          fi
          
          echo ""
          echo "Installation complete!"
          echo "Run CLI: susa"
          echo "Run IDE: susa-ide"
          EOF
          
          chmod +x SUSA-Complete-Linux/install.sh
          
          # Create README
          cat > SUSA-Complete-Linux/README.txt << 'EOF'
          SUSA Complete Package for Linux
          ================================
          
          This package includes:
          - SUSA CLI (command-line interpreter)
          - SUSA IDE (desktop application)
          - All modules and examples
          
          Installation:
          1. Extract this package
          2. Run: sudo ./install.sh
          
          After installation:
          - CLI: Run 'susa myfile.susa'
          - IDE: Run 'susa-ide' or find in applications menu
          
          For more information: https://susastudio.online
          EOF
          
          # Create tarball
          tar -czf SUSA-Complete-Linux-1.0.0.tar.gz SUSA-Complete-Linux
          ls -lh SUSA-Complete-Linux-1.0.0.tar.gz
      
      - name: Create macOS Complete Package
        run: |
          mkdir -p SUSA-Complete-macOS
          
          # Extract CLI package
          tar -xzf macos-cli/SUSA-CLI-macOS-1.0.0.tar.gz
          cp -r SUSA-CLI-macOS/* SUSA-Complete-macOS/
          
          # Copy IDE
          mkdir -p SUSA-Complete-macOS/ide
          cp macos-ide/*.dmg SUSA-Complete-macOS/ide/ 2>/dev/null || echo "No DMG found"
          cp macos-ide/*.zip SUSA-Complete-macOS/ide/ 2>/dev/null || echo "No ZIP found"
          
          # Create installation script
          cat > SUSA-Complete-macOS/install.sh << 'EOF'
          #!/bin/bash
          echo "Installing SUSA Complete Package for macOS..."
          echo ""
          
          # Install CLI
          echo "Installing CLI..."
          sudo cp bin/susa /usr/local/bin/
          sudo chmod +x /usr/local/bin/susa
          sudo mkdir -p /usr/local/share/susa
          sudo cp -r modules /usr/local/share/susa/
          sudo cp -r examples /usr/local/share/susa/
          echo "✓ CLI installed"
          
          # Install IDE
          if [ -f ide/*.dmg ]; then
            echo ""
            echo "Installing IDE..."
            echo "Please mount the DMG file in the 'ide' folder and drag SUSA IDE to Applications"
            open ide/*.dmg
          fi
          
          echo ""
          echo "Installation complete!"
          echo "Run CLI: susa"
          echo "Run IDE: Open from Applications folder"
          EOF
          
          chmod +x SUSA-Complete-macOS/install.sh
          
          # Create README
          cat > SUSA-Complete-macOS/README.txt << 'EOF'
          SUSA Complete Package for macOS
          ================================
          
          This package includes:
          - SUSA CLI (command-line interpreter)
          - SUSA IDE (desktop application)
          - All modules and examples
          
          Installation:
          1. Extract this package
          2. Run: ./install.sh
          
          For IDE:
          - Mount the DMG file in the 'ide' folder
          - Drag SUSA IDE to Applications
          
          After installation:
          - CLI: Run 'susa myfile.susa'
          - IDE: Open from Applications folder
          
          For more information: https://susastudio.online
          EOF
          
          # Create tarball
          tar -czf SUSA-Complete-macOS-1.0.0.tar.gz SUSA-Complete-macOS
          ls -lh SUSA-Complete-macOS-1.0.0.tar.gz
      
      - name: Upload Linux Complete Package
        uses: actions/upload-artifact@v4
        with:
          name: linux-complete
          path: SUSA-Complete-Linux-1.0.0.tar.gz
      
      - name: Upload macOS Complete Package
        uses: actions/upload-artifact@v4
        with:
          name: macos-complete
          path: SUSA-Complete-macOS-1.0.0.tar.gz
