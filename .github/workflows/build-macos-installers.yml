name: Build macOS Installers (CLI, IDE, Complete)

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

env:
  SUSA_VERSION: "1.0.0"

jobs:
  build-cli:
    name: macOS CLI Installer
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          clang++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Create package structure
        run: |
          mkdir -p package/usr/local/bin
          cp cpp-core/susa package/usr/local/bin/
          chmod +x package/usr/local/bin/susa
      
      - name: Create scripts
        run: |
          mkdir -p scripts
          cat > scripts/preinstall << 'EOF'
          #!/bin/bash
          pkill -9 susa 2>/dev/null || true
          exit 0
          EOF
          cat > scripts/postinstall << 'EOF'
          #!/bin/bash
          echo 'export PATH="$PATH:/usr/local/bin"' >> "$HOME/.zshrc"
          echo 'export PATH="$PATH:/usr/local/bin"' >> "$HOME/.bash_profile"
          echo "✅ SUSA CLI installed! Run 'susa --version'"
          exit 0
          EOF
          chmod +x scripts/*
      
      - name: Build PKG
        run: |
          pkgbuild --root package --identifier com.susa.cli --version ${{ env.SUSA_VERSION }} --scripts scripts --install-location / susa-cli.pkg
          productbuild --package susa-cli.pkg SUSA-CLI-${{ env.SUSA_VERSION }}.pkg
      
      - uses: actions/upload-artifact@v4
        with:
          name: macos-cli
          path: SUSA-CLI-${{ env.SUSA_VERSION }}.pkg

  build-ide:
    name: macOS IDE Installer
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build IDE with Electron Builder
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install
          npm run dist:mac
      
      - name: Find and Rename IDE Installer
        run: |
          installer=$(find susa-ide/remix-of-susa-studio-ide-main/dist-electron -name "*.dmg" -o -name "*.pkg" | head -n 1)
          if [ -n "$installer" ]; then
            cp "$installer" "SUSA-IDE-${{ env.SUSA_VERSION }}.dmg"
            echo "Found installer: $installer"
          else
            echo "No installer found!"
            exit 1
          fi
      
      - uses: actions/upload-artifact@v4
        with:
          name: macos-ide
          path: SUSA-IDE-${{ env.SUSA_VERSION }}.dmg

  build-complete:
    name: macOS Complete Installer
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          clang++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Build IDE
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install
          npm run dist:mac
      
      - name: Create Complete Package Structure
        run: |
          mkdir -p complete-package/usr/local/bin
          mkdir -p complete-package/Applications
          cp cpp-core/susa complete-package/usr/local/bin/
          chmod +x complete-package/usr/local/bin/susa
          
          # Find and copy the IDE app
          ide_app=$(find susa-ide/remix-of-susa-studio-ide-main/dist-electron -name "*.app" -type d | head -n 1)
          if [ -n "$ide_app" ]; then
            cp -R "$ide_app" complete-package/Applications/
            echo "Found IDE app: $ide_app"
          else
            echo "Warning: No IDE app found, creating placeholder"
            mkdir -p "complete-package/Applications/SUSA IDE.app/Contents/MacOS"
            echo "#!/bin/bash" > "complete-package/Applications/SUSA IDE.app/Contents/MacOS/SUSA IDE"
            echo "echo 'SUSA IDE'" >> "complete-package/Applications/SUSA IDE.app/Contents/MacOS/SUSA IDE"
            chmod +x "complete-package/Applications/SUSA IDE.app/Contents/MacOS/SUSA IDE"
          fi
      
      - name: Create scripts
        run: |
          mkdir -p scripts
          cat > scripts/preinstall << 'EOF'
          #!/bin/bash
          pkill -9 susa 2>/dev/null || true
          pkill -9 "SUSA IDE" 2>/dev/null || true
          exit 0
          EOF
          cat > scripts/postinstall << 'EOF'
          #!/bin/bash
          echo 'export PATH="$PATH:/usr/local/bin"' >> "$HOME/.zshrc"
          echo 'export PATH="$PATH:/usr/local/bin"' >> "$HOME/.bash_profile"
          echo "✅ SUSA Complete installed! CLI + IDE ready!"
          exit 0
          EOF
          chmod +x scripts/*
      
      - name: Build PKG
        run: |
          pkgbuild --root complete-package --identifier com.susa.complete --version ${{ env.SUSA_VERSION }} --scripts scripts --install-location / susa-complete.pkg
          productbuild --package susa-complete.pkg SUSA-Complete-${{ env.SUSA_VERSION }}.pkg
      
      - uses: actions/upload-artifact@v4
        with:
          name: macos-complete
          path: SUSA-Complete-${{ env.SUSA_VERSION }}.pkg
