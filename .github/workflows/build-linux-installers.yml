name: Build Linux Installers (CLI, IDE, Complete - DEB & RPM)

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

env:
  SUSA_VERSION: "1.0.0"

jobs:
  # ============================================
  # DEB PACKAGES (3 total)
  # ============================================
  
  build-cli-deb:
    name: Linux CLI DEB
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          g++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Create DEB package
        run: |
          mkdir -p susa-cli-deb/DEBIAN susa-cli-deb/usr/local/bin
          cp cpp-core/susa susa-cli-deb/usr/local/bin/
          chmod +x susa-cli-deb/usr/local/bin/susa
          
          cat > susa-cli-deb/DEBIAN/control << EOF
          Package: susa-cli
          Version: ${{ env.SUSA_VERSION }}
          Architecture: amd64
          Maintainer: SUSA Team <team@susastudio.online>
          Description: SUSA Programming Language CLI
           SUSA CLI compiler for command-line development.
          Homepage: https://susastudio.online
          Priority: optional
          Section: devel
          EOF
          
          cat > susa-cli-deb/DEBIAN/preinst << 'EOF'
          #!/bin/bash
          set -e
          pkill -9 susa 2>/dev/null || true
          exit 0
          EOF
          
          cat > susa-cli-deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          echo 'export PATH="$PATH:/usr/local/bin"' > /etc/profile.d/susa.sh
          chmod +x /etc/profile.d/susa.sh
          echo "✅ SUSA CLI installed! Run 'susa --version'"
          exit 0
          EOF
          
          cat > susa-cli-deb/DEBIAN/prerm << 'EOF'
          #!/bin/bash
          set -e
          pkill -9 susa 2>/dev/null || true
          exit 0
          EOF
          
          cat > susa-cli-deb/DEBIAN/postrm << 'EOF'
          #!/bin/bash
          set -e
          rm -f /etc/profile.d/susa.sh
          exit 0
          EOF
          
          chmod +x susa-cli-deb/DEBIAN/*
          dpkg-deb --build susa-cli-deb
          mv susa-cli-deb.deb susa-cli_${{ env.SUSA_VERSION }}_amd64.deb
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-cli-deb
          path: susa-cli_${{ env.SUSA_VERSION }}_amd64.deb

  build-ide-deb:
    name: Linux IDE DEB
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build IDE with Electron Builder
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install
          npm run dist:linux
      
      - name: Find and Rename IDE DEB
        run: |
          deb_file=$(find susa-ide/remix-of-susa-studio-ide-main/dist-electron -name "*.deb" | head -n 1)
          if [ -n "$deb_file" ]; then
            cp "$deb_file" "susa-ide_${{ env.SUSA_VERSION }}_amd64.deb"
            echo "Found DEB: $deb_file"
          else
            echo "No DEB found!"
            exit 1
          fi
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-ide-deb
          path: susa-ide_${{ env.SUSA_VERSION }}_amd64.deb

  build-complete-deb:
    name: Linux Complete DEB
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          g++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Build IDE
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install
          npm run build
      
      - name: Create DEB package
        run: |
          mkdir -p susa-complete-deb/DEBIAN
          mkdir -p susa-complete-deb/usr/local/bin
          mkdir -p susa-complete-deb/opt/susa-ide
          mkdir -p susa-complete-deb/usr/share/applications
          
          # Copy CLI
          cp cpp-core/susa susa-complete-deb/usr/local/bin/
          chmod +x susa-complete-deb/usr/local/bin/susa
          
          # Copy IDE build
          cp -r susa-ide/remix-of-susa-studio-ide-main/dist/* susa-complete-deb/opt/susa-ide/
          
          # Create desktop entry
          cat > susa-complete-deb/usr/share/applications/susa-ide.desktop << EOF
          [Desktop Entry]
          Name=SUSA IDE
          Exec=/opt/susa-ide/index.html
          Type=Application
          Categories=Development;
          Icon=/opt/susa-ide/susa-logo.png
          EOF
          
          cat > susa-complete-deb/DEBIAN/control << EOF
          Package: susa-complete
          Version: ${{ env.SUSA_VERSION }}
          Architecture: amd64
          Maintainer: SUSA Team <team@susastudio.online>
          Description: SUSA Complete (CLI + IDE)
           SUSA Programming Language with CLI compiler and Desktop IDE.
          Homepage: https://susastudio.online
          Priority: optional
          Section: devel
          EOF
          
          cat > susa-complete-deb/DEBIAN/preinst << 'EOF'
          #!/bin/bash
          set -e
          pkill -9 susa 2>/dev/null || true
          pkill -9 susa-ide 2>/dev/null || true
          exit 0
          EOF
          
          cat > susa-complete-deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          echo 'export PATH="$PATH:/usr/local/bin"' > /etc/profile.d/susa.sh
          chmod +x /etc/profile.d/susa.sh
          echo "✅ SUSA Complete installed! CLI + IDE ready"
          exit 0
          EOF
          
          cat > susa-complete-deb/DEBIAN/prerm << 'EOF'
          #!/bin/bash
          set -e
          pkill -9 susa 2>/dev/null || true
          pkill -9 susa-ide 2>/dev/null || true
          exit 0
          EOF
          
          cat > susa-complete-deb/DEBIAN/postrm << 'EOF'
          #!/bin/bash
          set -e
          rm -f /etc/profile.d/susa.sh
          exit 0
          EOF
          
          chmod +x susa-complete-deb/DEBIAN/*
          dpkg-deb --build susa-complete-deb
          mv susa-complete-deb.deb susa-complete_${{ env.SUSA_VERSION }}_amd64.deb
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-complete-deb
          path: susa-complete_${{ env.SUSA_VERSION }}_amd64.deb

  # ============================================
  # RPM PACKAGES (3 total)
  # ============================================
  
  build-cli-rpm:
    name: Linux CLI RPM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install RPM tools
        run: sudo apt-get update && sudo apt-get install -y rpm
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          g++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Create RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p susa-cli-${{ env.SUSA_VERSION }}
          cp cpp-core/susa susa-cli-${{ env.SUSA_VERSION }}/
          tar czf ~/rpmbuild/SOURCES/susa-cli-${{ env.SUSA_VERSION }}.tar.gz susa-cli-${{ env.SUSA_VERSION }}
          
          cat > ~/rpmbuild/SPECS/susa-cli.spec << 'EOF'
          Name: susa-cli
          Version: ${{ env.SUSA_VERSION }}
          Release: 1
          Summary: SUSA Programming Language CLI
          License: MIT
          URL: https://susastudio.online
          Source0: susa-cli-%{version}.tar.gz
          
          %description
          SUSA CLI compiler for command-line development.
          
          %prep
          %setup -q
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          install -m 0755 susa %{buildroot}/usr/local/bin/susa
          
          %pre
          pkill -9 susa 2>/dev/null || true
          exit 0
          
          %post
          echo 'export PATH="$PATH:/usr/local/bin"' > /etc/profile.d/susa.sh
          chmod +x /etc/profile.d/susa.sh
          echo "✅ SUSA CLI installed!"
          exit 0
          
          %preun
          pkill -9 susa 2>/dev/null || true
          exit 0
          
          %postun
          rm -f /etc/profile.d/susa.sh
          exit 0
          
          %files
          /usr/local/bin/susa
          
          %changelog
          * Fri Feb 28 2026 SUSA Team <team@susastudio.online> - ${{ env.SUSA_VERSION }}-1
          - Initial release
          EOF
          
          rpmbuild -ba ~/rpmbuild/SPECS/susa-cli.spec
          cp ~/rpmbuild/RPMS/x86_64/susa-cli-${{ env.SUSA_VERSION }}-1.*.rpm ./susa-cli-${{ env.SUSA_VERSION }}-1.x86_64.rpm
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-cli-rpm
          path: susa-cli-${{ env.SUSA_VERSION }}-1.x86_64.rpm

  build-ide-rpm:
    name: Linux IDE RPM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install RPM tools
        run: sudo apt-get update && sudo apt-get install -y rpm
      
      - name: Build IDE with Electron Builder
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install
          npm run dist:linux
      
      - name: Find and Rename IDE RPM
        run: |
          rpm_file=$(find susa-ide/remix-of-susa-studio-ide-main/dist-electron -name "*.rpm" | head -n 1)
          if [ -n "$rpm_file" ]; then
            cp "$rpm_file" "susa-ide-${{ env.SUSA_VERSION }}-1.x86_64.rpm"
            echo "Found RPM: $rpm_file"
          else
            echo "No RPM found!"
            exit 1
          fi
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-ide-rpm
          path: susa-ide-${{ env.SUSA_VERSION }}-1.x86_64.rpm

  build-complete-rpm:
    name: Linux Complete RPM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install RPM tools
        run: sudo apt-get update && sudo apt-get install -y rpm
      
      - name: Build SUSA Compiler
        run: |
          cd cpp-core
          g++ -std=c++17 -Wall -O2 -o susa main.cpp
          chmod +x susa
          ls -lh susa
      
      - name: Build IDE
        run: |
          cd susa-ide/remix-of-susa-studio-ide-main
          npm install
          npm run build
      
      - name: Create RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p susa-complete-${{ env.SUSA_VERSION }}/usr/local/bin
          mkdir -p susa-complete-${{ env.SUSA_VERSION }}/opt/susa-ide
          mkdir -p susa-complete-${{ env.SUSA_VERSION }}/usr/share/applications
          
          cp cpp-core/susa susa-complete-${{ env.SUSA_VERSION }}/usr/local/bin/
          cp -r susa-ide/remix-of-susa-studio-ide-main/dist/* susa-complete-${{ env.SUSA_VERSION }}/opt/susa-ide/
          
          tar czf ~/rpmbuild/SOURCES/susa-complete-${{ env.SUSA_VERSION }}.tar.gz susa-complete-${{ env.SUSA_VERSION }}
          
          cat > ~/rpmbuild/SPECS/susa-complete.spec << 'EOF'
          Name: susa-complete
          Version: ${{ env.SUSA_VERSION }}
          Release: 1
          Summary: SUSA Complete (CLI + IDE)
          License: MIT
          URL: https://susastudio.online
          Source0: susa-complete-%{version}.tar.gz
          
          %description
          SUSA Programming Language with CLI compiler and Desktop IDE.
          
          %prep
          %setup -q
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          mkdir -p %{buildroot}/opt/susa-ide
          mkdir -p %{buildroot}/usr/share/applications
          
          cp -r usr/local/bin/* %{buildroot}/usr/local/bin/
          cp -r opt/susa-ide/* %{buildroot}/opt/susa-ide/
          
          cat > %{buildroot}/usr/share/applications/susa-ide.desktop << EOFDESKTOP
          [Desktop Entry]
          Name=SUSA IDE
          Exec=/opt/susa-ide/index.html
          Type=Application
          Categories=Development;
          EOFDESKTOP
          
          %pre
          pkill -9 susa 2>/dev/null || true
          pkill -9 susa-ide 2>/dev/null || true
          exit 0
          
          %post
          echo 'export PATH="$PATH:/usr/local/bin"' > /etc/profile.d/susa.sh
          chmod +x /etc/profile.d/susa.sh
          echo "✅ SUSA Complete installed! CLI + IDE ready"
          exit 0
          
          %preun
          pkill -9 susa 2>/dev/null || true
          pkill -9 susa-ide 2>/dev/null || true
          exit 0
          
          %postun
          rm -f /etc/profile.d/susa.sh
          exit 0
          
          %files
          /usr/local/bin/susa
          /opt/susa-ide/*
          /usr/share/applications/susa-ide.desktop
          
          %changelog
          * Fri Feb 28 2026 SUSA Team <team@susastudio.online> - ${{ env.SUSA_VERSION }}-1
          - Initial release
          EOF
          
          rpmbuild -ba ~/rpmbuild/SPECS/susa-complete.spec
          cp ~/rpmbuild/RPMS/x86_64/susa-complete-${{ env.SUSA_VERSION }}-1.*.rpm ./susa-complete-${{ env.SUSA_VERSION }}-1.x86_64.rpm
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-complete-rpm
          path: susa-complete-${{ env.SUSA_VERSION }}-1.x86_64.rpm
